
> 摘要：全民K歌直播间PK礼物是为拉动营收上线的一个较新项目。在其上线后的三周多时间里，其对产品的营收带来了一些积极的效果。本文从技术角度简述全民K歌直播间PK礼物这一项目的总体设计与后台实现。

###一、项目简述
pk礼物是直播间主播与粉丝互动的一种新的玩法。简单来说，在直播间中，主播测可以发起两种礼物的PK，指明倒计时时长。在pk过程中，观众可以针对这两种礼物进行送礼。最终看哪种礼物胜出。有了这样一个入口，直播过程中就可以有多种玩法。比如：某礼物胜出主播唱首歌、另一种胜出跳支舞；pk胜出方topN主播送出线下礼品；连麦时的喜爱对比等。

###二、概要设计
针对上述的需求，可以知道此项目涉及到多方消息的传递，对消息的实时性及容错性要求较高、对结果的最终一致性要求较高。对此，我们设计了服务器push与客户端pull相结合的消息传递方式，动态数据及定时器由server维护的统一管理方式。通过IMSDK下发创建pk、结束pk及pk过程中的动态数据，并在IMSDK概率性失效时通过客户端pull的结果来容错。

####1. 总体设计
server提供创建pk、结束pk、获取pk过程中比对数据、获取最终结果、获取排行榜等接口。在主播创建pk后，server下发IM消息到直播间中每个用户，将此pk加入到定时器中开始倒计时，并将此pk的相关信息存储到ckv中。直播间送礼行为发生后，server从hippo中拉取送礼的流水，判断是否pk的礼物之一，若是，将其累加到pk的送礼数据中，并更新排行榜，下发IM消息至直播间。server判断某一pk倒计时结束后，同样写ckv，下发IM消息，同时不再更新送礼的数据及排行榜。
server分为四类：管理pk场次的server、拉送礼流水计算排行的server、管理排行及统计信息的server、错误处理redo server。
下面从接口、存储、定时器及容错等方面展开介绍。

####2. 接口设计
接口涉及两个部分，一个是暴露给client的接口，即webapp的接口，一个是后端server提供的接口，即spp server的接口。此外，将IM消息的设计也放在这部分介绍。

#####1) webapp

######a. 创建pk
创建pk时需要客户端带上showId，pk的两个giftId，每种礼物对应的文案（如：投它，我唱首浮夸），以及pk的默认时长。server收到消息后生成pkId下发，并带上interval字段，指示client pull的间隔时长。

######b. 结束pk
结束pk有两种方式，一种是client创建后不用关心什么时候关闭，等着server倒计时结束后自动下发的im消息即可。第二种是client主播测在pk还没有结束时手动触发关闭。在后一种情况下client需要将showId与pkId传上来，server回复中payload为空（但出错时会在包头有错误码）。

######c. 获取pk过程中比对数据
一旦主播侧创建成功，或者观众侧收到server下发的创建pk的im消息，client会按照interval指示的时长定期pull数据。这时调用的就是此接口。正常情况下pull时只要带上showId即可，但有一个补充bool字段needExtraInfo，其作为一个容错的字段，只有在观众侧没有收到创建pk的im消息但收到送礼时的im消息后需要置位后带上来。这点会在后面的容错章节详细说明。此不赘述。

######d. 获取最终结果
pk结束后，client拉取最终pk结果展示，需调用此接口。只需上传pkId即可。server返回两种礼物的送礼总数、对战总时长、当前用户的额送礼总数，以及一个送礼排行榜，这个榜只含有胜出一方的前5位，若打平，需要综合排名前5位（即不区分送的是哪个礼物）。同时有一个容错的字段，标识pk是否真的结束了，防止客户端倒计时过快导致较早拉取了非最终的结果。这点也会在容错章节详细说明。

######e. 获取排行榜
pk进行中时，用户点击pk比对数据的小图标可以呼起礼物对战的排行。这里会调用此接口。需要带上pkId、giftId以及一个index字段，index指示从排行榜第几位开始下发，目前设置一次下发20条榜单信息。

#####2) server

######a. 获取pkInfo
当拉取送礼流水的server从hippo中拉出了送礼数据后，需要判断是否要计算到排行榜中，这时候需要请求获取一次pkInfo，根据giftId及送礼的时间戳判断是否要计算进排行榜中。因为hippo中拉出的流水只有showId，没有pkId信息，所以此接口返回的是此showId下最后一场的pkInfo。

#####3) im消息

######a. 创建pk消息
主播侧创建后server需要给直播间所有观众推送创建pk的消息，由于观众侧很有可能没有拉过礼物面板，所以此消息除了pkId、pk时长、pull间隔时长、giftId，还需要带上giftName、giftLogo。

######b. 结束pk
结束时的im消息只要带上pkId即可。

######c. pk过程比对数据
下发pkId、giftId及送礼总数，此外还有个timeLeft字段指示还有多久pk结束，防止client倒计时不准确。

####3. 存储设计
存储均使用ckv存储，主要有以下四类。

#####1) pkInfo
pk的管理信息。key为showId。将一场直播下面的所有pk放在一个vector中存储。其中每条存放pkId、status（进行中|销毁）、giftId、giftDesc（创建时的文案）、giftName、giftLogo、createTime、destroyTime、创建时长等。

#####2) statInfo
pk的比对数据。key为pkId。存储礼物对应的送礼个数和送礼总KB数。

#####3) rankInfo
pk的排行榜数据。key为pkId_giftId。存储每场pk的每个礼物下的排行榜数据。

#####4) userInfo
每个user的送礼数据。key为pkId_uId_giftId。

####4. 定时器设计


### 三、概要设计


